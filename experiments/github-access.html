<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Understanding Dexie Promises</title>
    <link rel="icon" href="onsetsu-icon.png" type="image/png">
    <link href="log.css" rel="stylesheet"/>
    <link href="github-access-fonts.css" rel="stylesheet"/>
    <link href="github-access.css" rel="stylesheet"/>
    <script src="nav.js"></script>
    <style>
        ul#list { list-style-type:none;}
        ul#list li {
            overflow: visible;
            padding-left: 17px;
            position: relative;
        }
        ul#list li:before {
            content: 'üëÅÔ∏è';
            left: -10px;
            position: absolute;
        }
        ul#list li.private:before {
            content: 'üîí';
            left: -9px;
        }
        .error {
            background-color: #ffc4cc;
            border-radius: 5px;
            padding-left: 3px;
            padding-right: 3px;
        }
    </style>
</head>
<body>
<header>
    <script type="text/javascript">insertNavigation();</script>
</header>

<h1>Zone-based Layer Activation</h1>

<h3>Context-specific Behavior Adaptations across <br/>Logically-connected Asynchronous Operations</h3>

<p>Zone-based Layer Activation is a variant of dynamic extent that applies a behavior adaptation not only for the duration of a message send but also for all <span class="highlight">asynchronous</span> operations scheduled within the message send, transitively.</p>

<hr/>
<h4>Example Application: <span class="highlight">Querying Latest GitHub Commits</span></h4>

<p>This page exemplifies a usage scenario for Zone-based Layer Activation: Adapting the behavior of a program that queries the latest commits of a user on GitHub and performing further queries to enhance the displayed repositories with the time and message of the respective latest commit. You can query any one's public GitHub repositories by filling in the respective username:</p>

<style>
    .user-and-token {
        width:fit-content;
        display:flex;
        flex-direction:row;
        justify-content: space-around;
    }
    .input-block {
        margin: 2px 10px 2px 0px;
        position: relative;
        display:flex;
        flex-direction:column;
    }
    .text-label {
        position: absolute;
        top: 100%;
        left: 0;
        font-size: small;
    }
</style>
<div class="user-and-token">
    <div class="input-block">
        <label class='text-label' for="username">username</label>
        <input id='username' type="text" placeholder="your user name"/>
    </div>
    <div class="input-block">
        <input id='token' type="password" placeholder="your GitHub access token" title="Your token is required to display private repositories. It will not be collected in any manner in this page."/>
        <label class='text-label' for="token" style="position: absolute;top:100%;left:0;">GitHub access token</label>
    </div>
</div>

<p>You token is only required when you want to access your private repositories.</p>

<style>
    pre span.keyword {
        color: #008800;
        font-weight: bold;
    }
    pre.line-numbers {
        color: gray;
    }
</style>
<div style="background: #ffffff; overflow:auto;width:fit-content;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td style="border-right: 10px solid #FFF;"><pre class='line-numbers' style="margin: 0; line-height: 125%;">1
2
3
4
5
6
7</pre></td><td><pre style="margin: 0; line-height: 125%"><span class="keyword">async function</span> displayRepos() {
  <span class="keyword">const</span> repos = <span class="keyword">await</span> GitHub.repos()
  <span class="keyword">for</span> (<span class="keyword">let</span> repo <span class="keyword">of</span> repos) {
    <span class="keyword">const</span> commits = <span class="keyword">await</span> repo.commits()
    display(repo, commits[<span style="color: #0000DD; font-weight: bold">0</span>])
  }
}
</pre></td></tr></table></div>

The above code can be executed in any of the three provided variants:


<p>Please select a variant for code execution:</p>
<div>
    <input type="radio" id="variantPlain"
           name="variant" value="plain">
    <label for="variantPlain"><span class="highlight">plain:</span> unmodified behavior to access the most recently changes repositories of a user.</label>
</div>
<div>
    <input type="radio" id="variantWithLayers"
           name="variant" value="withLayers">
    <label for="variantWithLayers"><span class="highlight">withLayers:</span></label>
</div>
<div>
    <input type="radio" id="variantWithLayersZoned"
           name="variant" value="withLayersZoned">
    <label for="variantWithLayersZoned"><span class="highlight">withLayersZoned:</span></label>
</div>


<button id="fetch">Fetch Latest Repositories</button>
<button id="clear">Clear List</button>

<ul id="list"></ul>

</body>
<script  type="module" type="text/javascript">

import { withZone, withLayersZoned, withoutLayersZoned } from './../src/dynamic-extent-zoned.js';
import { Layer, withLayers, withoutLayers } from './../ContextJS/src/contextjs.js';

import DexiePromise, { Zone } from "../src/helpers/promise.js";

const GH_API = 'https://api.github.com/';
const username = document.querySelector('#username');
const token = document.querySelector('#token');

function headers() {
    return {
        headers: {
            Authorization: `token ${token.value}`
        }
    };
}

async function ghFetch(...args) {
    return new DexiePromise(async (resolve, reject) => {
        await fetch(...args)
            .then(r => r.json())
            .then(resolve)
            .catch(reject);
    });
}

class GitHub {
    static async repos() {
        let repos = await ghFetch(`${GH_API}users/${username.value}/repos?sort=updated&per_page=5&page=1`); // #TODO: 5 1
        return repos.map(r => new Repository(r));
    }
}

class Repository {
    constructor({private: isPrivate, name, url}) {
        this.name = name;
        this.url = url;
        this.isPrivate = isPrivate;
    }
    async commits() {
        let res;
        if (this.isPrivate) {
            res = [{ isError: true }];
        } else {
            // res = [defaultCommitDesc('public')]
            res = await ghFetch(this.url + '/commits?per_page=1&page=1');
        }
        return res.map(c => new Commit(c));
    }
}

class Commit {
    constructor(desc = {}, isError = false) {
        Object.assign(this, desc);
    }
    toString() {
        if (this.isError) {
            return `(<span class="error">resource not available!</span>)`;
        }
        const { commit: { author, message } } = this;
        const date = author.date.toString()
            .replace(/-/g, '.')
            .replace('T', ' ')
            .replace(/\:\d\dZ$/, '')
        const m = message.length > 30 ?
            message.substr(0, 30) + '...' :
            message;
        return `${date} ${m}`;
    }
}

Zone.current.displayColor = 'black';

function getList() {
    return document.body.querySelector('#list');
}

function display({ isPrivate, name, url }, commit) {
    getList().innerHTML += `<li class="${isPrivate ? 'private':''}" style="color: ${Zone.current.displayColor}"><span class="elli">${name} ${commit}</span></li>`
        .replace(/\n/gm, '<br />').replace(/<root>/gm, '&lt;root>');
}

async function displayRepos() {
    const repos = await GitHub.repos()
    for (let repo of repos) {
        const commits = await repo.commits()
        display(repo, commits[0])
    }
}

const AuthLayer = new Layer('AuthLayer')
    .refineObject(GitHub, {
        async repos() {
            let repos = await ghFetch(GH_API+'user/repos?affiliation=owner&sort=updated&visibility=all&per_page=6&page=1', headers());
            repos = repos.filter(repo => !repo.name.startsWith('grin'));
            return repos.map(r => new Repository(r));
        }
    })
    .refineClass(Repository, {
        async commits() {
            const res = await ghFetch(this.url + '/commits?per_page=1&page=1', headers());
            return res.map(c => new Commit(c));
        }
    });

const variantSelector = 'input[name=variant]';

function getCurrentVariant() {
    const checkedVariant = Array.from(document.querySelectorAll(variantSelector)).find(i => i.checked);
    return checkedVariant && checkedVariant.value;
}

function setCurrentVariant(value) {
    const inputToSelect = document.querySelector(variantSelector + `[value=${value}]`);

    if (!inputToSelect) {
        alert(`value ${value} cannot be selected.`);
        return;
    }

    document.querySelectorAll(variantSelector).forEach(i => i.checked = false);
    inputToSelect.checked = true;
}

const COLORS = ['#0070C0', '#ED7D31', '#00B050'];
let COLOR_INDEX = 0;

const codeVariants = {
    async plain() {
        await displayRepos();
    },
    async withLayers() {
        await withLayers([AuthLayer], displayRepos);
    },
    async withLayersZoned() {
        await withLayersZoned([AuthLayer], displayRepos);
    },
}

function withNextColor(callback) {
    const displayColor = COLORS[COLOR_INDEX];
    COLOR_INDEX = (COLOR_INDEX + 1) % COLORS.length;

    return withZone(callback, { displayColor });
}

async function fetchRepositories() {
    const variant = getCurrentVariant();
    if (!variant) {
        alert('No variant chosen!');
        return;
    }

    withNextColor(codeVariants[variant]);
}

document.querySelector('#fetch').addEventListener('click', fetchRepositories);
document.querySelector('#clear').addEventListener('click', () => getList().innerHTML = '');

username.addEventListener('input', e => localStorage.setItem('username', e.target.value));
username.value = localStorage.getItem('username') || 'onsetsu';

token.addEventListener('input', e => localStorage.setItem('token', e.target.value));
token.value = localStorage.getItem('token') || '';

document.querySelectorAll(variantSelector).forEach(i => {
    i.addEventListener('change', e => localStorage.setItem('variant', i.value));
});
setCurrentVariant(localStorage.getItem('variant') || 'plain')

</script>
<footer>
    <p><em>CSS/Design:</em> Toni Mattis (<a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a>)</p>
</footer>
</html>